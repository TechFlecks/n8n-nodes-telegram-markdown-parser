# TechFlecks Telegram Markdown Parser - Continuous Integration
#
# Copyright Â© 2025 TechFlecks  
# Licensed under TechFlecks Software License Agreement v1.0
#
# This workflow runs on every push and pull request to ensure code quality

name: ğŸ§ª Continuous Integration

on:
  push:
    branches: [main, master, develop]
    paths-ignore:
      - '**.md'
      - '.github/**'
      - 'docs/**'
  
  pull_request:
    branches: [main, master, develop]
    paths-ignore:
      - '**.md'
      - '.github/**'
      - 'docs/**'

env:
  NODE_VERSION: '20.15'

jobs:
  # Job 1: Code Quality & Testing
  test:
    name: ğŸ§ª Test & Quality Check
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: ['20.15', '21.x', '22.x']
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          npm audit --audit-level=moderate

      - name: ğŸ§¹ Code Quality Checks
        run: |
          echo "ğŸ” Running ESLint..."
          npx eslint nodes package.json || true
          
          echo "ğŸ¯ Running Prettier Check..."
          npx prettier --check nodes demo*.js index.js || true

      - name: ğŸ”¨ Build Project
        run: |
          echo "ğŸ—ï¸ Building TypeScript..."
          npm run build

      - name: ğŸ§ª Run Tests
        run: |
          echo "ğŸ§ª Running unit tests..."
          npm test

      - name: ğŸ“œ Validate TechFlecks License
        run: |
          echo "ğŸ“œ Checking TechFlecks license compliance..."
          npm run validate-license

      - name: ğŸš€ Test Demo Scripts
        run: |
          echo "ğŸ¯ Testing demo functionality..."
          timeout 30s npm run demo || true
          timeout 30s npm run demo-standalone || true

  # Job 2: Security Audit
  security:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ”’ Security Audit
        run: |
          echo "ğŸ” Running security audit..."
          npm audit --audit-level=moderate
          
          echo "ğŸ” Checking for known vulnerabilities..."
          npx audit-ci --moderate

  # Job 3: Build Verification
  build-test:
    name: ğŸ”¨ Build Verification
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ”¨ Test Build Process
        run: |
          echo "ğŸ—ï¸ Testing TypeScript compilation..."
          npm run build
          
          echo "ğŸ“¦ Verifying build output..."
          ls -la dist/
          
          echo "ğŸ” Testing package creation..."
          npm pack --dry-run

      - name: ğŸ“Š Bundle Analysis
        run: |
          echo "ğŸ“Š Analyzing bundle size..."
          npx bundlesize || true

  # Job 4: Cross-Platform Testing
  cross-platform:
    name: ğŸŒ Cross-Platform Test
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: ['20.15']
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ”¨ Build Project
        run: npm run build

      - name: ğŸ§ª Run Tests
        run: npm test

      - name: ğŸ“œ License Validation
        run: npm run validate-license

# Workflow Summary:
# ================
# This CI workflow ensures code quality on every push/PR:
#
# ğŸ§ª Test & Quality - Runs on multiple Node.js versions
# ğŸ”’ Security Audit - Checks for vulnerabilities  
# ğŸ”¨ Build Verification - Ensures clean builds
# ğŸŒ Cross-Platform - Tests on Linux, Windows, macOS
#
# Triggers on:
# - Push to main/master/develop branches
# - Pull requests to main/master/develop branches
# - Excludes documentation-only changes
#
# Contact: support@techflecks.com
